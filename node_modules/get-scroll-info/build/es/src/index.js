import _typeof from "reshow-runtime/es/helpers/typeof";
import { doc, win } from "win-doc";
import { UNDEFINED } from "reshow-constant";
var lastScrollStore = {};
var oDoc;
var oWin;
var isWebkit;
var docEl;
var domCount = 0;

var initDoc = function initDoc() {
  oDoc = doc();
  oWin = win();
  isWebkit = UNDEFINED !== _typeof(oDoc.webkitIsFullScreen);
  docEl = oDoc.documentElement;
};

var getScrollNode = function getScrollNode(el) {
  if (!oDoc) {
    initDoc();
  }

  if (!el && oDoc) {
    if (oDoc.scrollingElement) {
      el = oDoc.scrollingElement;
    } else if (isWebkit) {
      el = oDoc.body;
    } else {
      el = docEl;
    }
  }

  if (!el.id) {
    el.id = "scroll-info-" + domCount;
    domCount++;
  }

  return el;
};

var getScrollInfo = function getScrollInfo(el, margin) {
  el = getScrollNode(el);

  if (!margin) {
    margin = 50;
  }

  var w;
  var h;
  var nodeName = (el.nodeName || "").toLowerCase();
  var isRoot = "body" === nodeName || "html" === nodeName; // defined scrollWidth and scrollHeight first.
  // to know if have vertical or horizontal bar.

  var scrollWidth = el.scrollWidth;
  var scrollHeight = el.scrollHeight;

  if (isRoot) {
    w = Math.max(el.clientWidth || 0, oWin.innerWidth || 0);
    h = Math.max(el.clientHeight || 0, oWin.innerHeight || 0);
    var hasHorizontalBar = w < scrollWidth;
    var hasVerticalBar = h < scrollHeight;

    if (hasHorizontalBar) {
      h = el.clientHeight;
    }

    if (hasVerticalBar) {
      w = el.clientWidth;
    }
  } else {
    w = el.clientWidth;
    h = el.clientHeight;
  }

  var scrollLeft = el.scrollLeft;
  var scrollTop = el.scrollTop;
  var scrollBottom = scrollTop + h;
  var scrollRight = scrollLeft + w;
  var elId = el.id;
  var lastScroll = lastScrollStore[elId];
  var info = {
    atTop: scrollTop < margin,
    atRight: scrollRight > scrollWidth - margin,
    atBottom: scrollBottom > scrollHeight - margin,
    atLeft: scrollLeft < margin,
    isScrollDown: lastScroll && scrollTop > lastScroll.top,
    isScrollLeft: lastScroll && scrollLeft < lastScroll.left,
    isScrollRight: lastScroll && scrollLeft > lastScroll.left,
    isScrollUp: lastScroll && scrollTop < lastScroll.top,
    scrollWidth: scrollWidth,
    scrollHeight: scrollHeight,
    scrollNodeWidth: w,
    scrollNodeHeight: h,
    top: scrollTop,
    right: scrollRight,
    bottom: scrollBottom,
    left: scrollLeft
  };
  lastScrollStore[elId] = info;
  return info;
};

export default getScrollInfo;
export { getScrollNode };