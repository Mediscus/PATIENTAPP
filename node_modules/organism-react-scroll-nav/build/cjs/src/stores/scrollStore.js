"use strict";

require("core-js/modules/es.array.iterator.js");

require("core-js/modules/es.string.iterator.js");

require("core-js/modules/es.weak-map.js");

require("core-js/modules/web.dom-collections.iterator.js");

require("core-js/modules/es.object.define-property.js");

require("core-js/modules/es.object.get-own-property-descriptor.js");

var _interopRequireDefault = require("reshow-runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports["default"] = exports.Scroller = void 0;

require("core-js/modules/web.timers.js");

require("core-js/modules/es.array.for-each.js");

require("core-js/modules/es.object.to-string.js");

require("core-js/modules/web.dom-collections.for-each.js");

require("core-js/modules/es.function.bind.js");

require("core-js/modules/es.array.reduce.js");

var _objectSpread2 = _interopRequireDefault(require("reshow-runtime/helpers/objectSpread2"));

var _defineProperty2 = _interopRequireDefault(require("reshow-runtime/helpers/defineProperty"));

var _reshowFlux = require("reshow-flux");

var _getScrollInfo = _interopRequireDefault(require("get-scroll-info"));

var _getWindowOffset = require("get-window-offset");

var _getoffset = _interopRequireDefault(require("getoffset"));

var _getObjectValue = _interopRequireWildcard(require("get-object-value"));

var _reshowConstant = require("reshow-constant");

var _callFunc = _interopRequireWildcard(require("call-func"));

var _winDoc = require("win-doc");

var _testForPassiveScroll = _interopRequireDefault(require("../testForPassiveScroll"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

var incNum = 0;
var DEFAULT_SCROLL_ID = -1;

var Scroller = /*#__PURE__*/function () {
  function Scroller() {
    (0, _defineProperty2["default"])(this, "storeName", "delayScroll");
    (0, _defineProperty2["default"])(this, "isInitEvent", {});
    (0, _defineProperty2["default"])(this, "isInitResizeEvent", false);
    (0, _defineProperty2["default"])(this, "spys", {});
  }

  var _proto = Scroller.prototype;

  _proto.initResizeEvent = function initResizeEvent() {
    var oWin = (0, _winDoc.win)();

    if (!oWin.__null) {
      this.isInitResizeEvent = true;

      if (oWin.addEventListener) {
        oWin.addEventListener("resize", this.bindHandleResize);
      } else {
        oWin.attachEvent("onresize", this.bindHandleResize);
      }
    }
  };

  _proto.initEvent = function initEvent(el) {
    var _this = this;

    if ("undefined" !== typeof el) {
      if (el.addEventListener) {
        var supportsPassive = (0, _testForPassiveScroll["default"])();
        el.addEventListener("scroll", this.scrollMonitor, supportsPassive ? {
          passive: true
        } : false);
      } else {
        el.attachEvent("onscroll", this.scrollMonitor);
      }

      setTimeout(function () {
        _this.trigger(el); //for lazy content


        setTimeout(function () {
          return _this.trigger(el);
        }, 777);
      });

      if (!this.isInitResizeEvent) {
        this.initResizeEvent();
      }
    }
  };

  _proto.removeEvent = function removeEvent(el) {
    if (el !== null && el !== void 0 && el.removeEventListener) {
      el.removeEventListener("scroll", this.scrollMonitor);
    } else {
      el === null || el === void 0 ? void 0 : el.deachEvent("onscroll", this.scrollMonitor);
    }
  };

  _proto.handleResize = function handleResize() {
    var _this2 = this;

    (0, _reshowConstant.KEYS)(this.spys).forEach(function (scrollId) {
      return _this2.scrollMonitor({
        target: {
          id: scrollId
        }
      });
    });
  };

  _proto.runScrollMonitor = function runScrollMonitor(e) {
    var delay = this.store.getState().get("scrollDelay");
    this.scrollDebounce({
      delay: delay,
      args: [e === null || e === void 0 ? void 0 : e.target]
    });
  };

  _proto.triggerScroll = function triggerScroll(scrollNode) {
    var _this3 = this;

    var scrollId = (0, _getObjectValue["default"])(scrollNode, ["id"]) || DEFAULT_SCROLL_ID;
    var defaultMargin = this.store.getState().get("scrollMargin");
    var actives = {
      mdefault: null
    };
    var offsetCache = {};
    var arrMonitorScroll = [];
    var scroll = (0, _getScrollInfo["default"])();
    var scrollTop = scroll.top + defaultMargin;
    var margin;
    (this.spys[scrollId] || []).forEach(function (node) {
      var nodeEl = node.getOffsetEl();

      if (!nodeEl) {
        return;
      }

      var nodeId = _this3.getNodeId(node);

      var monitorScroll = (0, _callFunc["default"])(node.getMonitorScroll);
      var scrollMargin = (0, _callFunc["default"])(node.getScrollMargin);
      var pos = (0, _getoffset["default"])(nodeEl);

      if (monitorScroll) {
        if (scrollTop >= pos.top && scrollTop < pos.bottom) {
          actives.mdefault = nodeId;
        }

        arrMonitorScroll.push(node);
      }

      margin = scrollMargin ? scrollMargin : defaultMargin;
      pos = (0, _getWindowOffset.isOnScreen)(pos, scroll, margin);
      offsetCache[nodeId] = pos;
    });
    var allMonitorNodeLen = arrMonitorScroll.length;
    this.margins.forEach(function (margin) {
      scrollTop = scroll.top + margin;
      actives["m" + margin] = null;
      var i = allMonitorNodeLen;

      while (i--) {
        var node = arrMonitorScroll[i];

        var nodeId = _this3.getNodeId(node);

        var pos = offsetCache[nodeId];

        if (scrollTop >= pos.top && scrollTop <= pos.bottom - 1) {
          actives["m" + margin] = nodeId;
          break;
        }
      }
    });
    this.margins = this.margins.clear();
    this.dispatch((0, _objectSpread2["default"])((0, _objectSpread2["default"])({}, actives), {}, {
      nodes: offsetCache,
      scroll: scroll,
      storeName: this.storeName
    }));
  };

  _proto.getNode = function getNode(id) {
    if (this.arrMap && this.arrMap.get) {
      return (0, _getObjectValue.toJS)(this.arrMap.get(id));
    }
  };

  _proto.getOffset = function getOffset(id, callName) {
    var nodes = this.store.getMap("nodes");
    return nodes[id];
  };

  _proto.hasAttach = function hasAttach(node) {
    var attachToId = this.getAttachToId(node);

    if (this.spys[attachToId] && this.spys[attachToId].has(node)) {
      return attachToId;
    } else {
      return false;
    }
  };

  _proto.getNodeId = function getNodeId(node) {
    var id = (0, _callFunc["default"])(node.getId) || node.id;

    if (!id) {
      return this.setNodeId(node);
    } else {
      return id;
    }
  };

  _proto.setNodeId = function setNodeId(node) {
    var nextId = "spy-" + incNum;
    incNum++;

    if (node.setId) {
      node.setId(nextId);
    } else {
      node.id = nextId;
    }

    return nextId;
  };

  _proto.getAttachToId = function getAttachToId(node) {
    var attachTo = (0, _callFunc["default"])(node.getAttachTo);
    var attachToId;

    if (attachTo) {
      attachToId = this.getNodeId(attachTo);
    } else {
      var oWin = (0, _winDoc.win)();

      if (!oWin.__null) {
        node.setAttachTo(oWin);
      }

      attachToId = DEFAULT_SCROLL_ID;
    }

    return attachToId;
  };

  _proto.attach = function attach(node) {
    var nodeId = this.getNodeId(node);
    var attachToId = this.getAttachToId(node);

    if (!this.spys[attachToId]) {
      this.spys[attachToId] = (0, _reshowFlux.Set)().add(node);
    } else {
      this.spys[attachToId] = this.spys[attachToId].add(node);
    }

    this.arrNode = this.arrNode.set(nodeId, node);

    if (!this.isInitEvent[attachToId]) {
      this.isInitEvent[attachToId] = true;
      this.initEvent((0, _callFunc["default"])(node.getAttachTo));
    }

    return nodeId;
  };

  _proto.detach = function detach(node) {
    var attachToId = this.hasAttach(node);

    if (attachToId) {
      this.spys[attachToId] = this.spys[attachToId].remove(node);
      this.arrNode = this.arrNode["delete"](this.getNodeId(node));

      if (!this.spys[attachToId].size) {
        this.removeEvent(node.attachTo);
        delete this.spys[attachToId];
        this.isInitEvent[attachToId] = false;
      }
    }
  };

  _proto.addMargin = function addMargin(num) {
    this.margins = this.margins.add(num);
  };

  _proto.deleteMargin = function deleteMargin(num) {
    this.margins = this.margins.remove(num);
  };

  _proto.getInitialState = function getInitialState() {
    this.trigger = this.triggerScroll.bind(this);
    this.arrNode = (0, _reshowFlux.Map)();
    this.margins = (0, _reshowFlux.Set)();
    this.scrollMonitor = this.runScrollMonitor.bind(this);
    this.scrollDebounce = (0, _callFunc.debounce)(this.trigger);
    this.bindHandleResize = this.handleResize.bind(this);
    return (0, _reshowFlux.Map)({
      scrollDelay: 50,
      scrollMargin: 0
    });
  };

  _proto.reduce = function reduce(state, action) {
    return (0, _reshowFlux.mergeMap)(state, action);
  };

  return Scroller;
}();

exports.Scroller = Scroller;
var oDelayScroller = new Scroller();

var _ImmutableStore = (0, _reshowFlux.ImmutableStore)(oDelayScroller.reduce.bind(oDelayScroller), oDelayScroller.getInitialState.bind(oDelayScroller)),
    store = _ImmutableStore[0],
    delayScrollDispatch = _ImmutableStore[1];

store.scroller = oDelayScroller;
oDelayScroller.dispatch = delayScrollDispatch;
oDelayScroller.store = store;
var _default = store;
exports["default"] = _default;