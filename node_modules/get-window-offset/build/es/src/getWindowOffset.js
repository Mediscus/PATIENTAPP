import _objectSpread from "reshow-runtime/es/helpers/objectSpread2";
import _defineProperty from "reshow-runtime/es/helpers/defineProperty";
import getScrollInfo from "get-scroll-info";
import isOnScreen from "./isOnScreen";
import getDomPositionInfo from "./getDomPositionInfo";
import pos from "./positions";
var T = "T";
var R = "R";
var B = "B";
var L = "L";
var C = "C";

var getRevertLoc = function getRevertLoc(fromLoc) {
  var loc;

  switch (fromLoc) {
    case pos.TL:
      loc = pos.TR;
      break;

    case pos.TR:
      loc = pos.TL;
      break;

    case pos.BL:
      loc = pos.BR;
      break;

    case pos.BR:
      loc = pos.BL;
      break;

    default:
      loc = fromLoc;
      break;
  }

  return loc;
};

var calWindowOffset = function calWindowOffset(domInfo, scrollInfo) {
  var _distanceFlip;

  var distance = {
    top: domInfo.top - scrollInfo.top,
    right: scrollInfo.right - domInfo.right,
    bottom: scrollInfo.bottom - domInfo.bottom,
    left: domInfo.left - scrollInfo.left
  };
  var maxDistance = Math.max(distance.top, distance.right, distance.bottom, distance.left);
  var distanceFlip = (_distanceFlip = {}, _defineProperty(_distanceFlip, distance.top, T), _defineProperty(_distanceFlip, distance.right, R), _defineProperty(_distanceFlip, distance.bottom, B), _defineProperty(_distanceFlip, distance.left, L), _distanceFlip);
  var firstKey = distanceFlip[maxDistance];
  var secondKey;

  if (firstKey === T || firstKey === B) {
    var _distanceFlip2;

    distanceFlip = (_distanceFlip2 = {}, _defineProperty(_distanceFlip2, distance.right, R), _defineProperty(_distanceFlip2, distance.left, L), _distanceFlip2);
    secondKey = distanceFlip[Math.max(distance.left, distance.right)];
  } else {
    var _distanceFlip3;

    distanceFlip = (_distanceFlip3 = {}, _defineProperty(_distanceFlip3, distance.top, T), _defineProperty(_distanceFlip3, distance.bottom, B), _distanceFlip3);
    secondKey = distanceFlip[Math.max(distance.top, distance.bottom)];
  }

  var locs = [getRevertLoc(pos[firstKey + secondKey]), pos[firstKey + C], pos[secondKey + C], getRevertLoc(pos[secondKey + firstKey])];
  return {
    locs: locs,
    firstKey: firstKey,
    secondKey: secondKey
  };
};

var getWindowOffset = function getWindowOffset(dom, debug) {
  if (!dom) {
    console.warn("getWindowOffset not assign dom");
    return false;
  }

  var _getDomPositionInfo = getDomPositionInfo(dom),
      fixedNode = _getDomPositionInfo.fixedNode,
      scrollNode = _getDomPositionInfo.scrollNode,
      targetDomInfo = _getDomPositionInfo.domInfo;

  var scrollInfo = getScrollInfo();

  var cookScrollInfo = _objectSpread({}, scrollInfo);

  if (fixedNode) {
    var fixedScrollInfo = getScrollInfo(fixedNode);
    cookScrollInfo.top = fixedScrollInfo.top;
    cookScrollInfo.right = scrollInfo.scrollNodeWidth;
    cookScrollInfo.bottom = scrollInfo.scrollNodeHeight;
    cookScrollInfo.left = fixedScrollInfo.left;
  } else if (scrollNode) {
    var scrollNodeScrollInfo = getScrollInfo(scrollNode);
    cookScrollInfo.top += scrollNodeScrollInfo.top;
    cookScrollInfo.right += scrollNodeScrollInfo.left;
    cookScrollInfo.bottom += scrollNodeScrollInfo.top;
    cookScrollInfo.left += scrollNodeScrollInfo.left;
  }

  var domInfo = isOnScreen(targetDomInfo, cookScrollInfo);

  if (!domInfo.isOnScreen && false !== debug) {
    // should not break function here
    // not use return here
    console.warn("Dom is not in screen", {
      dom: dom,
      domInfo: domInfo,
      scrollInfo: scrollInfo,
      cookScrollInfo: cookScrollInfo
    });
  }

  var result = _objectSpread({
    domInfo: domInfo,
    scrollInfo: scrollInfo
  }, calWindowOffset(domInfo, cookScrollInfo));

  return result;
};

export default getWindowOffset;