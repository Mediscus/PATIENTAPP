"use strict";

var _interopRequireDefault = require("reshow-runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("reshow-runtime/helpers/interopRequireWildcard");

var _extends2 = _interopRequireDefault(require("reshow-runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("reshow-runtime/helpers/objectWithoutProperties"));

var _assertThisInitialized2 = _interopRequireDefault(require("reshow-runtime/helpers/assertThisInitialized"));

var _defineProperty2 = _interopRequireDefault(require("reshow-runtime/helpers/defineProperty"));

var _classCallCheck2 = _interopRequireDefault(require("reshow-runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("reshow-runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("reshow-runtime/helpers/inherits"));

var _createSuper2 = _interopRequireDefault(require("reshow-runtime/helpers/createSuper"));

var _slicedToArray2 = _interopRequireDefault(require("reshow-runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard(require("react"));

var _reshowFlux = require("reshow-flux");

var _chai = require("chai");

var _reshowUnit = require("reshow-unit");

var _Return = _interopRequireDefault(require("../Return"));

var _excluded = ["store", "initStates", "pathStates"];

var _div, _div2;

var _ImmutableStore = (0, _reshowFlux.ImmutableStore)(function (state, action) {
  switch (action.type) {
    case "config/reset":
      return (0, _reshowFlux.mergeMap)(state.clear(), action.params);

    default:
      if (Object.keys(action)) {
        return (0, _reshowFlux.mergeMap)(state, action);
      } else {
        return state;
      }

  }
}),
    _ImmutableStore2 = (0, _slicedToArray2["default"])(_ImmutableStore, 2),
    pageStore = _ImmutableStore2[0],
    dispatch = _ImmutableStore2[1];

describe("Test Return", function () {
  var _FakeComponent, _FakeComponent2, _FakeComponent3, _FakeComponent4;

  var TestEl = /*#__PURE__*/function (_PureComponent) {
    (0, _inherits2["default"])(TestEl, _PureComponent);

    var _super = (0, _createSuper2["default"])(TestEl);

    function TestEl() {
      (0, _classCallCheck2["default"])(this, TestEl);
      return _super.apply(this, arguments);
    }

    (0, _createClass2["default"])(TestEl, [{
      key: "render",
      value: function render() {
        return _div || (_div = /*#__PURE__*/_react["default"].createElement("div", null));
      }
    }]);
    return TestEl;
  }(_react.PureComponent);

  var FakeComponent = /*#__PURE__*/function (_PureComponent2) {
    (0, _inherits2["default"])(FakeComponent, _PureComponent2);

    var _super2 = (0, _createSuper2["default"])(FakeComponent);

    function FakeComponent() {
      var _this;

      (0, _classCallCheck2["default"])(this, FakeComponent);

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      _this = _super2.call.apply(_super2, [this].concat(args));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
        store: pageStore,
        initStates: ["data"],
        pathStates: {
          I13N: ["data", "I13N"]
        }
      });
      return _this;
    }

    (0, _createClass2["default"])(FakeComponent, [{
      key: "setNew",
      value: function setNew(k, v) {
        this.setState((0, _defineProperty2["default"])({}, k, v));
      }
    }, {
      key: "render",
      value: function render() {
        var _this2 = this;

        var _this$state = this.state,
            store = _this$state.store,
            initStates = _this$state.initStates,
            pathStates = _this$state.pathStates,
            otherState = (0, _objectWithoutProperties2["default"])(_this$state, _excluded);
        return /*#__PURE__*/_react["default"].createElement(_Return["default"], (0, _extends2["default"])({
          changeable: true,
          store: store,
          initStates: initStates,
          pathStates: pathStates
        }, this.props), /*#__PURE__*/_react["default"].createElement(TestEl, (0, _extends2["default"])({
          ref: function ref(el) {
            return _this2.el = el;
          }
        }, otherState)));
      }
    }]);
    return FakeComponent;
  }(_react.PureComponent);

  var reset;
  beforeEach(function () {
    dispatch("config/reset");
  });
  afterEach(function () {
    (0, _reshowUnit.cleanIt)();
  });
  it("assign props", function (done) {
    var wrap = (0, _reshowUnit.mount)(_FakeComponent || (_FakeComponent = /*#__PURE__*/_react["default"].createElement(FakeComponent, null)));
    var uFake = wrap.instance();
    dispatch({
      data: {
        foo: "bar",
        I13N: {
          aaa: "bbb"
        }
      }
    });
    setTimeout(function () {
      (0, _chai.expect)(uFake.el.props.data).to.deep.equal({
        foo: "bar",
        I13N: {
          aaa: "bbb"
        }
      });
      (0, _chai.expect)(uFake.el.props.I13N).to.deep.equal({
        aaa: "bbb"
      });
      uFake.setNew("pathStates", {
        foo: ["data", "foo"]
      });
      setTimeout(function () {
        (0, _chai.expect)(uFake.el.props.foo).to.equal("bar");
        done();
      });
    });
  });
  it("test Immutable path state", function (done) {
    var vDom = _FakeComponent2 || (_FakeComponent2 = /*#__PURE__*/_react["default"].createElement(FakeComponent, {
      immutable: true
    }));

    var wrap = (0, _reshowUnit.mount)(vDom);
    var uFake = wrap.instance();
    dispatch({
      data: {
        foo: "bar",
        I13N: {
          a: "b"
        }
      }
    });
    setTimeout(function () {
      var firstData = uFake.el.props.data;
      var firstI13N = uFake.el.props.I13N;
      uFake.setNew("bar", "bbb");
      var secondData = uFake.el.props.data;
      var secondI13N = uFake.el.props.I13N;
      (0, _chai.expect)(firstData === secondData).to.be["true"];
      (0, _chai.expect)(firstI13N === secondI13N).to.be["true"];
      (0, _chai.expect)(firstData.toJS()).to.deep.equal({
        foo: "bar",
        I13N: {
          a: "b"
        }
      });
      (0, _chai.expect)(firstI13N.toJS()).to.deep.equal({
        a: "b"
      });
      done();
    });
  });
  it("test path state should clean", function () {
    var wrap = (0, _reshowUnit.mount)(_FakeComponent3 || (_FakeComponent3 = /*#__PURE__*/_react["default"].createElement(FakeComponent, {
      immutable: true
    })));
    var uFake = wrap.instance();
    dispatch({
      data: ""
    });
    (0, _chai.expect)(uFake.el.props.I13N).to.undefined;
    var wrap1 = (0, _reshowUnit.mount)(_FakeComponent4 || (_FakeComponent4 = /*#__PURE__*/_react["default"].createElement(FakeComponent, null)));
    var uFake1 = wrap1.instance();
    (0, _chai.expect)(uFake1.el.props.I13N).to.undefined;
  });
  it("test child with function", function (done) {
    var i = 0;

    var vDom = /*#__PURE__*/_react["default"].createElement(_Return["default"], {
      store: pageStore,
      initStates: ["data"]
    }, function (props) {
      if (i && props.data) {
        (0, _chai.expect)(props).to.deep.equal({
          data: "foo"
        });
        done();
      } else {
        i++;
      }

      return _div2 || (_div2 = /*#__PURE__*/_react["default"].createElement("div", null));
    });

    var wrap = (0, _reshowUnit.mount)(vDom);
    dispatch({
      data: "foo"
    });
  });
});