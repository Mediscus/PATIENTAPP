"use strict";

var _interopRequireWildcard = require("reshow-runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("reshow-runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("reshow-runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("reshow-runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("reshow-runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("reshow-runtime/helpers/inherits"));

var _createSuper2 = _interopRequireDefault(require("reshow-runtime/helpers/createSuper"));

var _defineProperty2 = _interopRequireDefault(require("reshow-runtime/helpers/defineProperty"));

var _objectSpread2 = _interopRequireDefault(require("reshow-runtime/helpers/objectSpread2"));

var _slicedToArray2 = _interopRequireDefault(require("reshow-runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard(require("react"));

var _reshowFluxBase = require("reshow-flux-base");

var _chai = require("chai");

var _reshowUnit = require("reshow-unit");

var _useConnect = _interopRequireDefault(require("../useConnect"));

describe("Test Connect hook for more test", function () {
  var reducer;
  beforeEach(function () {
    reducer = (0, _reshowFluxBase.createReducer)(function (state, action) {
      return action;
    }, {});
  });
  it("could register with store", function (done) {
    var _reducer = reducer,
        _reducer2 = (0, _slicedToArray2["default"])(_reducer, 2),
        store = _reducer2[0],
        dispatch = _reducer2[1];

    var FakeComponent = function FakeComponent(props) {
      var state = (0, _useConnect["default"])({
        storeLocator: function storeLocator() {
          return store;
        },
        calculateState: function calculateState(prevState, props) {
          return {
            foo: store.getState().foo
          };
        }
      })(props);
      return /*#__PURE__*/_react["default"].createElement("div", null, state.foo);
    };

    var wrap = (0, _reshowUnit.mount)( /*#__PURE__*/_react["default"].createElement(FakeComponent, null));
    dispatch({
      foo: "bar"
    });
    setTimeout(function () {
      (0, _chai.expect)(wrap.html()).to.equal("<div>bar</div>");
      done();
    });
  });
  it("could work with dispatcher", function (done) {
    var _reducer3 = reducer,
        _reducer4 = (0, _slicedToArray2["default"])(_reducer3, 2),
        store = _reducer4[0],
        dispatch = _reducer4[1];

    var calculateTimes = 0;

    var FakeComponent = function FakeComponent(props) {
      var state = (0, _useConnect["default"])({
        storeLocator: function storeLocator() {
          return store;
        },
        calculateState: function calculateState(prevState, props) {
          var state = store.getState();
          calculateTimes++;
          return {
            aaa: state.aaa
          };
        }
      })(props);
      return /*#__PURE__*/_react["default"].createElement("div", null, state.aaa);
    };

    (0, _chai.expect)(calculateTimes).to.equal(0);
    var wrap = (0, _reshowUnit.mount)( /*#__PURE__*/_react["default"].createElement(FakeComponent, null));
    setTimeout(function () {
      (0, _chai.expect)(calculateTimes).to.equal(2); //init and handlchange

      dispatch({
        aaa: "Hello dispatcher!"
      });
      setTimeout(function () {
        wrap.update();
        (0, _chai.expect)(calculateTimes).to.equal(3);
        (0, _chai.expect)(wrap.html()).to.equal("<div>Hello dispatcher!</div>");
        wrap.unmount();
        dispatch({
          aaa: "Hello Unmount!"
        });
        (0, _chai.expect)(calculateTimes).to.equal(3);
        done();
      });
    });
  });
  it("could work withProps", function (done) {
    var getStoresProps = null;
    var calculateStateProps = null;

    var _reducer5 = reducer,
        _reducer6 = (0, _slicedToArray2["default"])(_reducer5, 2),
        store = _reducer6[0],
        dispatch = _reducer6[1];

    var FakeComponent = function FakeComponent(props) {
      var state = (0, _useConnect["default"])({
        storeLocator: function storeLocator(props) {
          getStoresProps = props;
          return store;
        },
        calculateState: function calculateState(prevState, props) {
          calculateStateProps = (0, _objectSpread2["default"])({}, props);
          return {
            foo: props.foo
          };
        }
      })(props);
      return /*#__PURE__*/_react["default"].createElement("div", null, state.foo);
    };

    var changeFoo;

    var Parent = /*#__PURE__*/function (_Component) {
      (0, _inherits2["default"])(Parent, _Component);

      var _super = (0, _createSuper2["default"])(Parent);

      function Parent(props) {
        var _this;

        (0, _classCallCheck2["default"])(this, Parent);
        _this = _super.call(this, props);
        (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {});

        changeFoo = function changeFoo(v) {
          _this.setState({
            foo: v
          });
        };

        return _this;
      }

      (0, _createClass2["default"])(Parent, [{
        key: "render",
        value: function render() {
          var foo = null;

          if (this.state && this.state.foo) {
            foo = this.state.foo;
          }

          return /*#__PURE__*/_react["default"].createElement(FakeComponent, {
            foo: foo,
            changeable: true
          });
        }
      }]);
      return Parent;
    }(_react.Component);

    var wrap = (0, _reshowUnit.mount)( /*#__PURE__*/_react["default"].createElement(Parent, null));
    (0, _chai.expect)(getStoresProps).to.deep.include({
      foo: null
    });
    (0, _chai.expect)(calculateStateProps).to.deep.include({
      foo: null
    });
    changeFoo("bar");
    wrap.update();
    setTimeout(function () {
      (0, _chai.expect)(wrap.html()).to.equal("<div>bar</div>");
      (0, _chai.expect)(getStoresProps).to.deep.include({
        foo: "bar"
      });
      (0, _chai.expect)(calculateStateProps).to.deep.include({
        foo: "bar"
      });
      done();
    });
  });
  it("could work with empty calculateState", function () {
    var _reducer7 = reducer,
        _reducer8 = (0, _slicedToArray2["default"])(_reducer7, 2),
        store = _reducer8[0],
        dispatch = _reducer8[1];

    var FakeComponent = function FakeComponent(props) {
      var state = (0, _useConnect["default"])({
        storeLocator: function storeLocator() {
          return store;
        },
        calculateState: function calculateState(prevState, props) {}
      })(props);
      return /*#__PURE__*/_react["default"].createElement("div", null, state.foo);
    };

    var wrap = (0, _reshowUnit.mount)( /*#__PURE__*/_react["default"].createElement(FakeComponent, {
      aaa: "bbb"
    }));
    var props = wrap.props();
    (0, _chai.expect)(props).to.deep.include({
      aaa: "bbb"
    });
  });
});