"use strict";

var _interopRequireWildcard = require("reshow-runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("reshow-runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("reshow-runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("reshow-runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("reshow-runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("reshow-runtime/helpers/inherits"));

var _createSuper2 = _interopRequireDefault(require("reshow-runtime/helpers/createSuper"));

var _defineProperty2 = _interopRequireDefault(require("reshow-runtime/helpers/defineProperty"));

var _slicedToArray2 = _interopRequireDefault(require("reshow-runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard(require("react"));

var _chai = require("chai");

var _reshowUnit = require("reshow-unit");

var _sinon = _interopRequireDefault(require("sinon"));

var _reshowFluxBase = require("reshow-flux-base");

var _useConnect = _interopRequireDefault(require("../useConnect"));

describe("useConnect Unmount Test", function () {
  var sandbox = _sinon["default"].createSandbox();

  var reducer;
  beforeEach(function () {
    reducer = (0, _reshowFluxBase.createReducer)(function (state, action) {
      return action;
    }, {});
  });
  afterEach(function () {
    sandbox.restore();
  });
  it("basic test", function (done) {
    var _Foo;

    var _reducer = reducer,
        _reducer2 = (0, _slicedToArray2["default"])(_reducer, 2),
        store = _reducer2[0],
        dispatch = _reducer2[1];

    var Foo = function Foo(props) {
      var state = (0, _useConnect["default"])({
        storeLocator: function storeLocator() {
          return store;
        },
        calculateState: function calculateState(prevState, props) {
          return store.getState();
        }
      })(props);
      return /*#__PURE__*/_react["default"].createElement("div", {
        className: state.foo
      });
    };

    var FakeComponent = /*#__PURE__*/function (_PureComponent) {
      (0, _inherits2["default"])(FakeComponent, _PureComponent);

      var _super = (0, _createSuper2["default"])(FakeComponent);

      function FakeComponent() {
        var _this;

        (0, _classCallCheck2["default"])(this, FakeComponent);

        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
          args[_key] = arguments[_key];
        }

        _this = _super.call.apply(_super, [this].concat(args));
        (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
          show: true
        });
        return _this;
      }

      (0, _createClass2["default"])(FakeComponent, [{
        key: "set",
        value: function set(k, v) {
          this.setState((0, _defineProperty2["default"])({}, k, v));
        }
      }, {
        key: "render",
        value: function render() {
          if (this.state.show) {
            return _Foo || (_Foo = /*#__PURE__*/_react["default"].createElement(Foo, null));
          } else {
            return null;
          }
        }
      }]);
      return FakeComponent;
    }(_react.PureComponent);

    var wrap = (0, _reshowUnit.mount)( /*#__PURE__*/_react["default"].createElement(FakeComponent, null));
    var oFake = wrap.instance();
    sandbox.spy(store, "removeListener");
    console.log("before unmount", store.removeListener.callCount);
    (0, _chai.expect)(store.removeListener.callCount).to.equal(0);
    oFake.set("show", false);
    (0, _chai.expect)(store.removeListener.callCount).to.equal(1);
    console.log("after unmount", store.removeListener.callCount);
    dispatch({});
    done();
  });
});