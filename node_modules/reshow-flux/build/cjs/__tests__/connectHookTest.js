"use strict";

var _interopRequireWildcard = require("reshow-runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("reshow-runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("reshow-runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("reshow-runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("reshow-runtime/helpers/inherits"));

var _createSuper2 = _interopRequireDefault(require("reshow-runtime/helpers/createSuper"));

var _slicedToArray2 = _interopRequireDefault(require("reshow-runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard(require("react"));

var _chai = require("chai");

var _reshowUnit = require("reshow-unit");

var _reshowFluxBase = require("reshow-flux-base");

var _useConnect = _interopRequireDefault(require("../useConnect"));

describe("Test Connect Hook", function () {
  var reducer;
  beforeEach(function () {
    reducer = (0, _reshowFluxBase.createReducer)(function (state, action) {
      return action;
    });
  });
  it("basic test", function (done) {
    var _reducer = reducer,
        _reducer2 = (0, _slicedToArray2["default"])(_reducer, 2),
        store = _reducer2[0],
        dispatch = _reducer2[1];

    var Foo = function Foo(props) {
      var state = (0, _useConnect["default"])({
        storeLocator: function storeLocator() {
          return store;
        },
        calculateState: function calculateState(prevState, opt) {
          return opt.storeState;
        }
      })(props);
      return /*#__PURE__*/_react["default"].createElement("div", {
        className: state.foo
      });
    };

    var wrap = (0, _reshowUnit.mount)( /*#__PURE__*/_react["default"].createElement(Foo, null));
    (0, _chai.expect)(wrap.html()).to.equal("<div></div>");
    var a = {
      foo: "111"
    };
    dispatch(a);
    setTimeout(function () {
      (0, _chai.expect)(wrap.html()).to.equal('<div class="111"></div>');
      dispatch({
        foo: "222"
      });
      setTimeout(function () {
        (0, _chai.expect)(wrap.html()).to.equal('<div class="222"></div>');
        done();
      });
    });
  });
  it("test Warnings for some updates during render", function (done) {
    var _Foo;

    var _reducer3 = reducer,
        _reducer4 = (0, _slicedToArray2["default"])(_reducer3, 2),
        store = _reducer4[0],
        dispatch = _reducer4[1];
    /**
     * https://fb.me/setstate-in-render
     * https://reactjs.org/blog/2020/02/26/react-v16.13.0.html#warnings-for-some-updates-during-render
     */


    var init = 0;

    var Foo = function Foo(props) {
      var state = (0, _useConnect["default"])({
        storeLocator: function storeLocator() {
          return store;
        },
        calculateState: function calculateState(prevState, opt) {
          return opt.storeState;
        }
      })(props);

      if (init <= 1) {
        dispatch({
          foo: "bar"
        });
      }

      init++;
      return /*#__PURE__*/_react["default"].createElement("div", {
        className: state.foo
      });
    };

    var VDom = /*#__PURE__*/function (_Component) {
      (0, _inherits2["default"])(VDom, _Component);

      var _super = (0, _createSuper2["default"])(VDom);

      function VDom() {
        (0, _classCallCheck2["default"])(this, VDom);
        return _super.apply(this, arguments);
      }

      (0, _createClass2["default"])(VDom, [{
        key: "componentDidCatch",
        value: function componentDidCatch(error, errorInfo) {
          console.log({
            error: error,
            errorInfo: errorInfo
          });
        }
      }, {
        key: "render",
        value: function render() {
          return _Foo || (_Foo = /*#__PURE__*/_react["default"].createElement(Foo, null));
        }
      }]);
      return VDom;
    }(_react.Component);

    var wrap = (0, _reshowUnit.mount)( /*#__PURE__*/_react["default"].createElement(VDom, null));
    setTimeout(function () {
      (0, _chai.expect)(wrap.html()).to.equal('<div class="bar"></div>');
      done();
    });
  });
});
describe("Test Connect Hook", function () {
  var reducer;
  beforeEach(function () {
    reducer = (0, _reshowFluxBase.createReducer)(function (state, action) {
      return action;
    });
    (0, _reshowUnit.hideConsoleError)();
  });
  afterEach(function () {
    (0, _reshowUnit.cleanIt)();
  });
  it("test store not defined", function () {
    var _Foo2;

    var _reducer5 = reducer,
        _reducer6 = (0, _slicedToArray2["default"])(_reducer5, 2),
        store = _reducer6[0],
        dispatch = _reducer6[1];

    var Foo = function Foo(props) {
      var state = (0, _useConnect["default"])({
        calculateState: function calculateState(prevState, opt) {
          return opt.storeState;
        }
      })(props);
      return /*#__PURE__*/_react["default"].createElement("div", {
        className: state.foo
      });
    };

    (0, _chai.expect)(function () {
      (0, _reshowUnit.mount)(_Foo2 || (_Foo2 = /*#__PURE__*/_react["default"].createElement(Foo, null)));
    }).to["throw"]();
  });
});